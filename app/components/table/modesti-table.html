<style>
  .table-wrapper {
    border-left: 1px solid #CCC;
    border-right: 1px solid #CCC;
  }

  .table-wrapper table {
    margin-bottom: 0;
  }

  li > a.new-tab {
    border-top: 1px dashed #ccc !important;
    border-right: 1px dashed #ccc !important;
    border-left: 1px;
    border-bottom: 1px !important;
    border-top-right-radius: 5px;
    border-top-left-radius: 0;
    padding: 4px 10px 3px;
  }

  li > a.new-tab:hover, li > a.new-tab:focus {
    background: #EEEEEE;
    border-top: 1px solid #CCC !important;
    border-right: 1px solid #CCC !important;
    border-left: 1px;
    border-bottom: 1px !important;
  }

  li > ul.new-tab-menu {
    margin-top: 1px !important;
    margin-left: -1px;
  }

  tr.ng-isolate-scope.fsm-sticky-header {
    background-color: #fff;
    margin-left: 1px;
  }

  .ng-table th.sortable.sort-desc, .ng-table th.sortable.sort-asc {
    background-color: rgba(141, 192, 219, 0.05);
  }

  select.form-control {
    padding: 0 !important;
  }

  .ng-table-rowselected tr {
    cursor: pointer;
  }

  .loading-container {
    position: relative;
  }

  .loading-container .loading:before, .loading-container .loading:after {
    content: " ";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    min-height: 50px;
    min-width: 50px;
  }

  .loading-container .loading:before {
    background-color: white;
    opacity: 0.5;
  }

  .table > tbody > tr > td .form-control {
    transition: none;
  }

  .table > tbody > tr.success > td .form-control {
    background-color: #DFF0D8;
    border-color: #DFF0D8;
  }

</style>

<!-- Alerts are shown here -->
<alert ng-repeat="alert in alerts"
       type="{{alert.type}}"
       close="ctrl.closeAlert($index)">
  {{alert.message}}
</alert>

<alert ng-if="ctrl.request.validationResult && !ctrl.request.validationResult.valid"
       type="danger"
       close>
  Validation failed. Please see the error report for details.
</alert>

<div class="nav-tabs">

  <!-- Create a new tab for each category -->
  <tabset class="category-headings">
    <!-- Categories are only shown if they are enabled for the current workflow state -->
    <tab ng-repeat="category in ctrl.schema.categories | enabled:ctrl.request.status track by category.name"
         heading="{{::category.name}}"
         select="ctrl.activateCategory(category)"
         class="category-heading"></tab>

    <!-- Button to dynamically add a new tab category -->
    <li dropdown ng-show="::ctrl.request.status == 'IN_PROGRESS'">
      <a dropdown-toggle class="new-tab dropdown-toggle" href="">
        <i class="fa fa-plus-square-o"></i>
      </a>
      <ul class="new-tab-menu dropdown-menu" role="menu">
        <li ng-repeat="tab in ctrl.availableCategories">
          <a ng-click="ctrl.addNewCategory(tab)">{{::tab}}</a>
        </li>
        <li ng-show="ctrl.availableCategories.length == 0" class="dropdown-header">
          No categories available
        </li>
      </ul>
    </li>
  </tabset>

  <div class="table-wrapper" loading-container="ctrl.tableParams.settings().$loading">

  <!-- This is the actual point input table itself -->
  <table id="table"
         ng-table="ctrl.tableParams"
         class="table table-bordered table-striped ng-table-rowselected"
         template-pagination="custom/pager">
         <!--fixed-header table-height="500px">-->


    <thead>
      <!-- The fsm-sticky-header makes the table headers stick to the top of the page when scrolling -->
      <tr>
        <!-- Column header for the point ID -->
        <th class="sortable"
            ng-class="ctrl.getSortingClass('id')"
            ng-click="ctrl.toggleSorting('id')">
          <div class="sort-indicator">#</div>
        </th>

        <!-- Column header for each field in the currently active category -->
        <th quick-ng-repeat="field in ctrl.allFields"
            quick-repeat-list="ctrl.allFields"
            class="text-left sortable"
            ng-show="ctrl.activeCategory.fields.indexOf(field) > -1"
            ng-class="ctrl.getSortingClass('properties.' + field.id)"
            ng-click="ctrl.toggleSorting('properties.' + field.id)">
            <div class="sort-indicator">{{field.name}}</div>
        </th>

        <!-- Checkbox column header -->
        <th>
          <input type="checkbox"
                 ng-model="ctrl.checkboxes.checked"
                 id="select_all"
                 name="filter-checkbox"
                 value="" />
        </th>
      </tr>

      <!-- Special table row containing filter boxes -->
      <tr ng-show="show_filter">
        <th style="vertical-align: middle;">
          <a ng-click="ctrl.toggleFilter()"><i class="fa fa-times"></i></a>
        </th>
        <th ng-repeat="field in ctrl.activeCategory.fields track by field.id"
            class="text-center sortable">
          <input type="text"
                 class="form-control"
                 ng-model="ctrl.searchText[field.id]"
                 ng-model-options="{debounce: 250}" />
        </th>
        <th></th>
      </tr>
    </thead>

    <tbody ng-form="ctrl.tableForm">
      <!-- Row for each point in the request -->
      <tr quick-ng-repeat="point in $data"
          quick-repeat-list="$data"
          ng-form="ctrl.pointForms.form_{{::$index}}"
          ng-click="point.$selected = !point.$selected"
          ng-class="{
                      'success' : point.approved && ctrl.request.status == 'FOR_APPROVAL' }">


          <!-- Line number field -->
          <td class="input-field text-muted"
              width="30"
              style="text-align: center; vertical-align: middle;"
              ng-class="{ 'bg-danger': (ctrl.pointForms.form_{{::$index}}.$invalid   && ctrl.pointForms.form_{{::$index}}.$dirty)
                                    || (ctrl.pointForms.form_{{::$index}}.$submitted && ctrl.pointForms.form_{{::$index}}.$invalid)}">
            {{point.id}}
          </td>


          <!--Input field for each field in the currently active category-->
          <td quick-ng-repeat="field in ctrl.allFields"
              quick-repeat-list="ctrl.allFields"
              class="input-field"
              ng-show="ctrl.activeCategory.fields.indexOf(field) > -1">


            <!-- Custom directive to generate an input field based on the field schema -->
            <span input-field
                  model="point.properties[field.id]"
                  schema="::field"
                  editable="{{::ctrl.activeCategory.editableStates.indexOf(ctrl.request.status) > -1}}"></span>
          </td>


          <!-- Checkbox for each point -->
          <td class="input-field" width="30" style="text-align: center; vertical-align: middle;">
            <input type="checkbox" ng-model="ctrl.checkboxes.items[point.id]" />
          </td>


      </tr>
    </tbody>

    <!-- Table footer toolbar -->
    <tfoot>
      <tr>
        <td colspan="20">

          <div class="row">
            <div class="col-md-3">

              <!-- Button to save the request -->
              <button class="btn btn-default" ng-click="ctrl.save()" tooltip-append-to-body="true" tooltip="Save request">
                <i class="fa fa-fw fa-save saving-state"></i>

                <!-- Saving state indicators -->
                <span ng-show="$root.saving == 'started'">
                  <i class="fa fa-fw fa-spin fa-cog saving-state"></i>
                </span>
                <span ng-show="$root.saving == 'success'">
                  <i class="fa fa-fw fa-check saving-state text-success"></i>
                </span>
                <span ng-show="$root.saving == 'error'">
                  <i class="fa fa-fw fa-exclamation-triangle saving-state text-danger"></i>
                </span>
              </button>

              <!-- Button to activate the filter text boxes at the top of the table -->
              <button class="btn btn-default" ng-click="ctrl.toggleFilter()" tooltip-append-to-body="true" tooltip="Filter rows">
                <i class="fa fa-fw fa-filter"></i>
              </button>
            </div>

            <!-- Custom pagination controls -->
            <div class="col-md-6">
              <div class="ng-cloak ng-table-pager text-center" ng-if="params.data.length">
                <ul class="pagination ng-table-pagination" ng-hide="params.settings().$scope.pages == 0">
                  <li ng-class="{'disabled': !page.active && !page.current, 'active': page.current}" ng-repeat="page in pages" ng-switch="page.type">
                    <a ng-switch-when="prev"  ng-click="params.page(page.number)" href="">&laquo;</a>
                    <a ng-switch-when="first" ng-click="params.page(page.number)" href=""><span ng-bind="page.number"></span></a>
                    <a ng-switch-when="page"  ng-click="params.page(page.number)" href=""><span ng-bind="page.number"></span></a>
                    <a ng-switch-when="more"  ng-click="params.page(page.number)" href="">&#8230;</a>
                    <a ng-switch-when="last"  ng-click="params.page(page.number)" href=""><span ng-bind="page.number"></span></a>
                    <a ng-switch-when="next"  ng-click="params.page(page.number)" href="">&raquo;</a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-md-3">
              <div ng-if="params.settings().counts.length" class="ng-table-counts btn-group pull-right">
                <button ng-repeat="count in params.settings().counts" type="button"
                        ng-class="{'active':params.count() == count}"
                        ng-click="params.count(count)" class="btn btn-default">
                  <span ng-bind="count"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Remove default pagination -->
          <script type="text/ng-template" id="custom/pager"></script>

        </td>
      </tr>

      <tr>
        <td colspan="100">
          <!-- This is where the status-specific controls are inserted -->
          <span ng-transclude></span>
        </td>
      </tr>
    </tfoot>

  </table>
  </div>
</div>

<div class="col-md-10">
  <small>form valid: <code>{{ctrl.tableForm.$valid}}</code></small>
  <br />
  <small>form dirty: <code>{{ctrl.tableForm.$dirty}}</code></small>
  <br />
  <small>tasks: <code ng-repeat="task in ctrl.tasks"> {{::task.name}}</code></small>
  <br />
  <small>validation result: <code>{{::ctrl.request.validationResult}}</code></small>
  <br />
  <small>approval result: <code>{{::ctrl.request.approvalResult}}</code></small>
  <br />
  <small>addressing result: <code>{{::ctrl.request.addressingResult}}</code></small>
  <br />
  <small>configuration result: <code>{{::ctrl.request.configurationResult}}</code></small>
  <br />
  <small>test result: <code>{{::ctrl.request.testResult}}</code></small>
  <br />
  <br />
  <small>alerts: <code>{{$root.alerts}}</code></small>
</div>