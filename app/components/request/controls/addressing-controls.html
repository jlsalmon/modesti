<!--
  If we are allowed to address:
    - if the task is not claimed, show a claim button
    - if we have claimed the task, show the addressing controls (also show delegation controls)
    - if the task is claimed by someone else, show the assignee username

  If we are not allowed to address:
    - show no controls
-->

<accordion class="accordion">
  <accordion-group is-open="ctrl.errorLogOpen" is-disabled="ctrl.getNumValidationErrors() == 0">
    <accordion-heading>

      <div class="row">

        <div class="col-md-3">
          <span class="label pull-left"
                ng-class="ctrl.getNumValidationErrors() > 0 ? 'bg-red' : 'bg-gray'"
                tooltip="{{ctrl.getNumValidationErrors()}} error(s) found. Click to view details."
                tooltip-placement="right">
            <i class="fa fa-fw fa-exclamation-circle"></i> {{ctrl.getNumValidationErrors()}}
          </span>
        </div>

        <div class="col-md-9">
          <!-- Only show controls when we have permission to address -->
          <div ng-if="ctrl.isCurrentUserAuthorised()" class="pull-right">

            <!-- Request has been claimed -->
            <div ng-if="ctrl.isCurrentTaskClaimed()">

              <!-- Request has been claimed by us -->
              <div ng-if="ctrl.isCurrentUserAssigned()">

                <!--<div class="btn-group">-->
                  <!--<button class="btn btn-danger"  ng-click="ctrl.rejectRequest($event)" translate>Reject request</button>-->
                <!--</div>-->

                <div class="btn-group">
                  <!--Button to validate the request-->
                  <button class="btn btn-success"
                          ng-click="ctrl.validate($event)"
                          ng-disabled="!ctrl.canValidate()"
                          tooltip-append-to-body="true"
                          tooltip="{{'VALIDATE_REQUEST'|translate}}">

                    <!--Show icon based on the loading state-->
                    <i class="fa fa-fw fa-check-square-o"       ng-show="ctrl.validating == undefined"></i>
                    <i class="fa fa-fw fa-spin fa-cog"          ng-show="ctrl.validating == 'started'"></i>
                    <i class="fa fa-fw fa-check-square-o"       ng-show="ctrl.validating == 'success'"></i>
                    <i class="fa fa-fw fa-exclamation-triangle" ng-show="ctrl.validating == 'error'"></i>
                    {{'VALIDATE'|translate}}
                  </button>
                </div>

                <div class="btn-group">

                  <button class="btn btn-primary"
                          ng-click="ctrl.submit($event)"
                          ng-disabled="!ctrl.canSubmit()"
                          tooltip-append-to-body="true"
                          tooltip="{{ 'SUBMIT_ADDRESSING' | translate}}">

                    <!--Show icon based on the loading state-->
                    <i class="fa fa-fw fa-external-link"        ng-show="ctrl.submitting == undefined"></i>
                    <i class="fa fa-fw fa-spin fa-cog"          ng-show="ctrl.submitting == 'started'"></i>
                    <i class="fa fa-fw fa-external-link"        ng-show="ctrl.submitting == 'success'"></i>
                    <i class="fa fa-fw fa-exclamation-triangle" ng-show="ctrl.submitting == 'error'"></i>
                    {{ 'SUBMIT' | translate}}
                  </button>

                </div>
              </div>

              <!-- Request is assigned to someone else -->
              <div ng-if="!ctrl.isCurrentUserAssigned()">
                <div>Request assigned to: <a href="#/users/{{ctrl.getCurrentAssignee()}}" ng-click="$event.stopPropagation();">{{ctrl.getCurrentAssignee()}}</a></div>
              </div>

            </div>

            <!-- Request is unclaimed -->
            <div ng-if="!ctrl.isCurrentTaskClaimed()">
              <div class="btn-group">
                <button class="btn btn-primary"
                        ng-click="ctrl.claim($event)">
                  Begin addressing
                </button>
              </div>
            </div>

          </div>

        </div>

      </div>
    </accordion-heading>

    <div ng-if="ctrl.getNumValidationErrors() > 0">
      <p>
        The request has failed validation. Please review the following lines which explain the validation failures. The
        request should be modified before revalidation.
      </p>

      <div ng-repeat="point in ctrl.rows track by point.id">
        <div ng-repeat="error in point.errors track by $index">
          <div ng-repeat="error in error.errors">
            <i class="fa fa-fw fa-exclamation-circle text-danger"></i> Line {{point.id}}: {{error}}
          </div>
        </div>
      </div>
    </div>

  </accordion-group>
</accordion>
